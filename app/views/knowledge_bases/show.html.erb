<div class="container mx-auto p-6">
  <!-- 面包屑导航 -->
  <nav class="flex mb-6 text-sm">
    <%= link_to "首页", root_path, class: "text-muted-foreground hover:text-foreground" %>
    <span class="mx-2 text-muted-foreground">/</span>
    <%= link_to "知识库", knowledge_bases_path, class: "text-muted-foreground hover:text-foreground" %>
    <span class="mx-2 text-muted-foreground">/</span>
    <span class="font-medium"><%= @knowledge_base.name %></span>
  </nav>

  <!-- 知识库标题和操作 -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold"><%= @knowledge_base.name %></h1>
      <% if @knowledge_base.description.present? %>
        <p class="text-muted-foreground mt-2"><%= @knowledge_base.description %></p>
      <% end %>
    </div>
    <div class="flex space-x-2">
      <%= render_dialog do %>
        <%= dialog_trigger do %>
          <%= render_button variant: :outline, class: "flex items-center space-x-2" do %>
            <%= lucide_icon "edit", class: "w-4 h-4" %>
            <span>编辑</span>
          <% end %>
        <% end %>
        <%= dialog_content do %>
          <%= render "form", knowledge_base: @knowledge_base %>
        <% end %>
      <% end %>
      <%= button_to knowledge_base_path(@knowledge_base), 
                  method: :delete, 
                  form: { data: { turbo_confirm: "确定要删除这个知识库吗？所有知识条目将被永久删除。" } },
                  class: "flex items-center space-x-2 px-4 py-2 bg-destructive text-destructive-foreground rounded-md hover:bg-destructive/90" do %>
        <%= lucide_icon "trash-2", class: "w-4 h-4" %>
        <span>删除</span>
      <% end %>
    </div>
  </div>

  <!-- 添加知识条目的选项卡 -->
  <div class="mb-6 border border-border rounded-lg overflow-hidden" data-controller="ui--tab-buttons">
    <div class="flex border-b border-border bg-muted/50">
      <button class="flex-1 p-3 text-center font-medium border-b-2 border-primary" 
              data-ui--tab-buttons-target="tab" 
              data-tab-id="file" 
              data-action="click->ui--tab-buttons#switchTab">
        文件上传
      </button>
      <button class="flex-1 p-3 text-center font-medium border-b-2 border-transparent text-muted-foreground" 
              data-ui--tab-buttons-target="tab" 
              data-tab-id="url" 
              data-action="click->ui--tab-buttons#switchTab">
        添加网址
      </button>
      <button class="flex-1 p-3 text-center font-medium border-b-2 border-transparent text-muted-foreground" 
              data-ui--tab-buttons-target="tab" 
              data-tab-id="note" 
              data-action="click->ui--tab-buttons#switchTab">
        添加笔记
      </button>
    </div>
    
    <!-- 文件上传表单 -->
    <div class="p-4" data-ui--tab-buttons-target="content" data-content-id="file">
      <div class="border-2 border-dashed border-border rounded-lg p-6 text-center" data-controller="file-upload">
        <div data-file-upload-target="dropzone" class="cursor-pointer">
          <%= form_with url: upload_file_knowledge_base_knowledge_entries_path(@knowledge_base), 
                        method: :post, 
                        multipart: true,
                        data: { file_upload_target: "form" } do |form| %>
            <div class="mb-4">
              <%= lucide_icon "upload-cloud", class: "w-12 h-12 mx-auto text-muted-foreground" %>
            </div>
            <p class="mb-2 font-semibold">拖拽文件到这里或点击上传</p>
            <p class="text-sm text-muted-foreground mb-4">支持 TXT, MD, HTML, PDF, DOCX, PPTX, XLSX, EPUB... 格式</p>
            <%= form.file_field :file, 
                              direct_upload: true,
                              class: "hidden", 
                              data: { 
                                file_upload_target: "input",
                                action: "change->file-upload#handleFileSelect"
                              } %>
            <%= render_button type: :button, 
                            variant: :outline,
                            data: { action: "click->file-upload#triggerFileInput" } do %>
              选择文件
            <% end %>
          <% end %>
        </div>
        <div data-file-upload-target="preview" class="hidden mt-4">
          <div class="flex items-center p-3 bg-muted rounded-md">
            <%= lucide_icon "file", class: "w-5 h-5 mr-2 text-muted-foreground" %>
            <span data-file-upload-target="filename" class="flex-1 truncate"></span>
            <button type="button" class="ml-2 text-destructive" data-action="click->file-upload#clearFile">
              <%= lucide_icon "x", class: "w-4 h-4" %>
            </button>
          </div>
          <div class="mt-4">
            <%= render_button data: { action: "click->file-upload#uploadFile" } do %>
              上传文件
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 添加网址表单 -->
    <div class="p-4 hidden" data-ui--tab-buttons-target="content" data-content-id="url">
      <%= form_with url: add_url_knowledge_base_knowledge_entries_path(@knowledge_base), method: :post do |form| %>
        <div class="space-y-4">
          <div>
            <%= form.label :title, "标题", class: "block text-sm font-medium mb-1" %>
            <%= form.text_field :title, required: true, class: "w-full" %>
          </div>
          <div>
            <%= form.label :source_url, "URL地址", class: "block text-sm font-medium mb-1" %>
            <%= form.url_field :source_url, required: true, class: "w-full" %>
          </div>
          <div class="flex justify-end">
            <%= form.submit "添加URL", class: "bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/90" %>
          </div>
        </div>
      <% end %>
    </div>
    
    <!-- 添加笔记表单 -->
    <div class="p-4 hidden" data-ui--tab-buttons-target="content" data-content-id="note">
      <%= form_with url: add_note_knowledge_base_knowledge_entries_path(@knowledge_base), method: :post do |form| %>
        <div class="space-y-4">
          <div>
            <%= form.label :title, "标题", class: "block text-sm font-medium mb-1" %>
            <%= form.text_field :title, required: true, class: "w-full" %>
          </div>
          <div>
            <%= form.label :content, "内容", class: "block text-sm font-medium mb-1" %>
            <%= form.text_area :content, required: true, rows: 8, class: "w-full" %>
          </div>
          <div class="flex justify-end">
            <%= form.submit "添加笔记", class: "bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/90" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 搜索框 -->
  <div class="mb-6">
    <%= form_with url: knowledge_base_path(@knowledge_base), method: :get, class: "flex" do |form| %>
      <%= form.text_field :query, 
                         placeholder: "搜索知识条目...", 
                         value: params[:query], 
                         class: "flex-1 px-4 py-2 border border-border rounded-l-md focus:outline-none focus:ring-2 focus:ring-ring" %>
      <%= form.button type: :submit, class: "px-4 py-2 bg-primary text-primary-foreground rounded-r-md hover:bg-primary/90" do %>
        <%= lucide_icon "search", class: "w-4 h-4" %>
      <% end %>
    <% end %>
  </div>

  <!-- 知识条目列表 -->
  <% if @knowledge_entries.any? %>
    <div class="border border-border rounded-lg overflow-hidden">
      <div class="bg-muted/50 p-3 border-b border-border flex justify-between items-center">
        <h2 class="font-semibold">知识条目</h2>
        <span class="text-sm text-muted-foreground"><%= pluralize(@knowledge_entries.count, "条目") %></span>
      </div>
      <div class="divide-y divide-border">
        <% @knowledge_entries.each do |entry| %>
          <div class="p-4 hover:bg-muted/30">
            <div class="flex justify-between items-start">
              <div class="flex items-start space-x-3">
                <% case entry.source_type %>
                <% when "file" %>
                  <%= lucide_icon "file-text", class: "w-5 h-5 text-muted-foreground flex-shrink-0 mt-1" %>
                <% when "url" %>
                  <%= lucide_icon "link", class: "w-5 h-5 text-muted-foreground flex-shrink-0 mt-1" %>
                <% when "note" %>
                  <%= lucide_icon "file", class: "w-5 h-5 text-muted-foreground flex-shrink-0 mt-1" %>
                <% end %>
                <div>
                  <h3 class="font-medium"><%= entry.title %></h3>
                  <% if entry.url? && entry.source_url.present? %>
                    <a href="<%= entry.source_url %>" target="_blank" class="text-sm text-primary hover:underline flex items-center mt-1">
                      <%= entry.source_url.truncate(50) %>
                      <%= lucide_icon "external-link", class: "w-3 h-3 ml-1" %>
                    </a>
                  <% end %>
                  <% if entry.note? && entry.content.present? %>
                    <p class="text-sm text-muted-foreground mt-1 line-clamp-2"><%= entry.content %></p>
                  <% end %>
                  <% if entry.file? && entry.file.attached? %>
                    <div class="text-sm text-muted-foreground mt-1 flex items-center">
                      <span><%= number_to_human_size(entry.file.byte_size) %></span>
                      <% if entry.content.present? %>
                        <span class="mx-2">•</span>
                        <span>已提取内容</span>
                      <% else %>
                        <span class="mx-2">•</span>
                        <span class="text-warning">内容提取中...</span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="flex space-x-1">
                <%= render_dialog do %>
                  <%= dialog_trigger do %>
                    <%= render_button variant: :ghost, size: :sm, class: "p-1" do %>
                      <%= lucide_icon "edit", class: "w-4 h-4" %>
                    <% end %>
                  <% end %>
                  <%= dialog_content do %>
                    <%= render "knowledge_entries/form", knowledge_base: @knowledge_base, knowledge_entry: entry %>
                  <% end %>
                <% end %>
                <%= button_to knowledge_base_knowledge_entry_path(@knowledge_base, entry), 
                            method: :delete, 
                            form: { data: { turbo_confirm: "确定要删除这个知识条目吗？" } },
                            class: "p-1 text-destructive hover:bg-destructive/10 rounded" do %>
                  <%= lucide_icon "trash-2", class: "w-4 h-4" %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- 分页 -->
    <div class="mt-6">
      <%== pagy_nav(@pagy) if defined?(@pagy) %>
    </div>
  <% else %>
    <div class="border border-border rounded-lg p-8 text-center">
      <div class="mb-4">
        <%= lucide_icon "file-question", class: "w-12 h-12 mx-auto text-muted-foreground" %>
      </div>
      <h3 class="text-lg font-semibold mb-2">还没有知识条目</h3>
      <p class="text-muted-foreground mb-4">使用上方的选项添加文件、网址或笔记</p>
    </div>
  <% end %>
</div> 